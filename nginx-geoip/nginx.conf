load_module /usr/lib/nginx/modules/ngx_http_geoip2_module.so;
load_module /usr/lib/nginx/modules/ngx_stream_geoip2_module.so;

user  nginx;
worker_processes  auto;
error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;

events {
    worker_connections  1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format main '$geoip2_data_country_code -- $status -- '
                    '$remote_addr [$time_local] "$request" '
                    '$body_bytes_sent "$http_user_agent"';
    access_log /var/log/nginx/access.log main;

    # GeoIP2 Country Database
    geoip2 /usr/share/GeoIP/GeoLite2-Country.mmdb {
        auto_reload 60m;
        $geoip2_data_country_code country iso_code;
    }

    # Allow only India and Singapore
    map $geoip2_data_country_code $allowed_country {
        default 0;
        IN 1;
        SG 1;
    }

    # Private IP whitelist (always allow LAN)
    geo $private_ip {
        default 0;
        <xx_lan_subnet_xx>/24 1;
        192.168.1.0/24 1;
        10.0.0.0/8 1;
        172.16.0.0/12 1;
        127.0.0.0/8 1;
    }

    # Combined logic: allow if country OK or private IP
    map "$allowed_country:$private_ip" $block_request {
        default 1;
        "1:0" 0;
        "1:1" 0;
        "0:1" 0;
    }

    # DoH reverse proxy (port 443)
    server {
        listen 443 ssl http2;
        server_name <xx_domain_xx>;

        ssl_certificate /etc/letsencrypt/live/<xx_domain_xx>/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/<xx_domain_xx>/privkey.pem;

        # Block non-allowed countries
        if ($block_request) {
            return 403;
        }

        # DoH endpoint — proxy to AdGuard HTTP (unencrypted DoH)
        location /dns-query {
            proxy_pass http://<xx_server_ip_xx>:8080/dns-query;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_pass_request_body on;
            proxy_set_header Content-Type $content_type;
            proxy_set_header Accept $http_accept;
        }

        # AdGuard WebUI — GeoIP protected, AdGuard handles its own login
        location = /adguard {
            return 301 /adguard/;
        }

        location /adguard/ {
            proxy_pass http://<xx_server_ip_xx>:8080/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_redirect / /adguard/;

            # Rewrite absolute paths in HTML/JS responses
            sub_filter_once off;
            sub_filter_types text/html text/css text/javascript application/javascript application/json;
            sub_filter 'href="/' 'href="/adguard/';
            sub_filter "href='/" "href='/adguard/";
            sub_filter 'src="/' 'src="/adguard/';
            sub_filter "src='/" "src='/adguard/";
            sub_filter 'action="/' 'action="/adguard/';
            sub_filter 'url("/' 'url("/adguard/';
            sub_filter 'url(/' 'url(/adguard/';
            sub_filter '"/control/' '"/adguard/control/';
            sub_filter "'/control/" "'/adguard/control/";
            sub_filter '"/login' '"/adguard/login';
            sub_filter "'/login" "'/adguard/login";
            sub_filter 'fetch("/' 'fetch("/adguard/';
            sub_filter "fetch('/" "fetch('/adguard/";
            sub_filter '"/__locales/' '"/adguard/__locales/';
            sub_filter '"/static/' '"/adguard/static/';
            sub_filter 'window.location="/' 'window.location="/adguard/';
            sub_filter "window.location='/" "window.location='/adguard/";
            sub_filter 'location.href="/' 'location.href="/adguard/';
            sub_filter "location.href='/" "location.href='/adguard/";
            sub_filter 'location.replace("/' 'location.replace("/adguard/';
        }

        # Public landing page
        location / {
            root /usr/share/nginx/html;
            index index.html;
        }
    }
}

# DoT stream proxy (port 853) with GeoIP blocking
stream {
    # GeoIP2 Country Database for stream
    geoip2 /usr/share/GeoIP/GeoLite2-Country.mmdb {
        auto_reload 60m;
        $geoip2_stream_country_code country iso_code;
    }

    # Allow only India and Singapore
    map $geoip2_stream_country_code $stream_allowed_country {
        default 0;
        IN 1;
        SG 1;
    }

    # Private IP whitelist
    geo $stream_private_ip {
        default 0;
        <xx_lan_subnet_xx>/24 1;
        192.168.1.0/24 1;
        10.0.0.0/8 1;
        172.16.0.0/12 1;
        127.0.0.0/8 1;
    }

    # Route allowed traffic to AdGuard, blocked traffic to nowhere
    map "$stream_allowed_country:$stream_private_ip" $dot_backend {
        default 127.0.0.1:1;       # Blocked — connection refused
        "1:0" <xx_server_ip_xx>:8530;  # Allowed country
        "1:1" <xx_server_ip_xx>:8530;  # Allowed country + private IP
        "0:1" <xx_server_ip_xx>:8530;  # Private IP (any country)
    }

    log_format stream_main '$remote_addr [$time_local] '
                           'country=$geoip2_stream_country_code '
                           'upstream=$dot_backend '
                           'status=$status';
    access_log /var/log/nginx/stream_access.log stream_main;

    # Pass TLS through without terminating — AdGuard handles TLS
    server {
        listen 8530;
        proxy_pass $dot_backend;
    }
}
